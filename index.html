<!DOCTYPE html>


<html>
<head>
    <title>Pyodide Worker Timeout</title>
	<link rel="stylesheet" href="styles.css">
	<!-- Core CodeMirror -->
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/codemirror.min.css">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/codemirror.min.js"></script>

	<!-- Language mode (optional) -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.19/mode/python/python.min.js"></script>
</head>
<body>
<header> </header>
<div id="container">
	<div id="level-selection-area">
	<ul>
	<li>Level 1</li>
	<li>Level 2</li>
	<li>Level 3</li>
	<li>Level 4</li>
	</ul>
	</div>

	<div id="code-area">
		<textarea id="code-input"> i 
		need
		some
		lines</textarea>
		<div id="playback-controls">
			<button id="playback-step-backward">
				<svg class="icon"><use href="img/icons.svg#skip-backward"></use></svg>   
			</button>
			<button id="playback-slower"> 
				<svg class="icon"><use href="img/icons.svg#dash"></use></svg>   
			</button>
			
			<button id="playback-play-pause"> 
				<svg class="icon"><use href="img/icons.svg#play"></use></svg>	
			</button>
			
			<button id="playback-faster"> 
				<svg class="icon"><use href="img/icons.svg#plus"></use></svg>   
			</button>

			<button id="playback-step-forward">
				<svg class="icon"><use href="img/icons.svg#skip-forward"></use></svg>   
			</button>
		</div>
		<div id="code-output" contenteditable="true">
	<!--svg class="icon"><use href="img/icons.svg#pause"></use></svg-->   




		</div>
	</div>
	<div id="game-view">
		<div id="grid"></div>
	</div>
</div>
</body>

<script src="BoardView.js"></script>
<!--script src="TextHighlighter.js"></script--->
<script>

const grid = document.getElementById("grid");
const boardView = new BoardView(grid);

const codeInput = document.getElementById("code-input");

const editor = CodeMirror.fromTextArea(codeInput, {
	lineNumbers: true,
	lineWrapping: true,
	mode: "python",
	tjeme: "default"

});
let highlightedLine = 1;
editor.addLineClass(0, "background", "highlighted-line");

var pyodideWorker = null;

function startOrRestartPyodideWorker(){
	if (pyodideWorker) pyodideWorker.terminate()
	pyodideWorker = new Worker("worker.js");
	pyodideWorker.addEventListener("message", (event) => {
		if (event.data.type === "execution-trace"){
			initView(event.data.trace);	
		}
	});
}

startOrRestartPyodideWorker();

document.addEventListener('keydown', (event) => {
	if (event.ctrlKey && event.key === "Enter"){
		const code = editor.getValue();
		console.log(code);
		pyodideWorker.postMessage({ code: code});
		// TODO: handle the timeout in case of infinite loops, etc
	}

	const k = event.key;
	switch(k){
	case '0':	
	case '1':	
	case '2':	
	case '3':	
	case '4':	
	case '5':	
	case '6':	
	case '7':	
	case '8':	
	case '9':	
	const line = parseInt(k);
	editor.removeLineClass(highlightedLine-1, "background", "highlighted-line");
	highlightedLine = line;
	editor.addLineClass(highlightedLine-1, "background", "highlighted-line");
	break;


	}
});

// We assume that the entire trace is valid
function initView(trace){
	boardView.resetGameState(trace[0].level)		
}

function gameover(win){
	console.log("Game over");
	console.log(win ? "WINNER"  : "LOSER");
}

function notifyResultOfIsColor(color, result){
	console.log(`Is current cell ${color}? ${result? "yes" : "no"}`) 

}

function highlightLineOfCode(lineno){
	console.log(`Executing line number ${lineno}`);
}	

function handleTraceMessage(msg){
	switch (msg.type) {
    case "initial-configuration":
	initView(msg.level);
	break;

	case "move": 
	moveAgent(msg.pos)
	break

	case "collected":
	consumeTarget(msg.pos);

	break;
	case "gameover":
	gameover(msg.win);
	break;
	
	case "turn":
	rotateAgent(msg.dir);
	break;
	
	case "isColor":
	notifyResultOfIsColor(msg.color, msg.result);
	break;
	
	case "lineExecuted":
	highlightLineOfCode(msg.lineno);
	break;
	}
}

function runTrace(executionTrace){
    //const sleep = ms => new Promise(resolve => setTimeout(resolve, ms));
	
	for (let msg of executionTrace){
		handleTraceMessage(msg);
	}
}

function exampleLevel(){
    const level = `        {
                 "grid": [
                         ".rgrrgbB",
                         ".....bb.",
                         "....bb..",
                         "...bb...",
                         "..bb....",
                         ".bb.....",
                         "bb......"
                 ],
                 "pos": [6,0],
                 "dir": 0
         }`

	return JSON.parse(level)
}

</script>
</html>

